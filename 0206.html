<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>超级玛丽亚</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #87CEEB;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 400px;
            overflow: hidden;
            background-color: #87CEEB;
            border: 4px solid #333;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        #game-canvas {
            display: block;
            background-color: #87CEEB;
        }
        
        #controls {
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr;
            gap: 10px;
        }
        
        .control-btn {
            background-color: #E52521;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            box-shadow: 0 5px 0 #8B0000;
        }
        
        .control-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }
        
        #left-btn {
            grid-column: 1;
        }
        
        #jump-btn {
            grid-column: 2;
        }
        
        #right-btn {
            grid-column: 3;
        }
        
        #game-stats {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #333;
            color: white;
            border-radius: 5px 5px 0 0;
            margin-bottom: 5px;
        }
        
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            display: none;
        }
        
        #game-over h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #E52521;
            text-shadow: 2px 2px 4px #000;
        }
        
        #restart-btn {
            background-color: #E52521;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 5px 0 #8B0000;
        }
        
        #restart-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }
        
        @media (max-height: 600px) {
            #game-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div id="game-stats">
        <div>生命: <span id="lives">3</span></div>
        <div>金币: <span id="coins">0</span></div>
        <div>分数: <span id="score">0</span></div>
    </div>
    
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div id="game-over">
            <h2>游戏结束!</h2>
            <div>最终分数: <span id="final-score">0</span></div>
            <button id="restart-btn">重新开始</button>
        </div>
    </div>
    
    <div id="controls">
        <button class="control-btn" id="left-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <button class="control-btn" id="jump-btn">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button class="control-btn" id="right-btn">
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>

    <script>
        // 游戏配置
        const config = {
            gravity: 0.5,
            playerSpeed: 5,
            jumpForce: 12,
            groundHeight: 40,
            enemySpeed: 2,
            coinValue: 100,
            enemyValue: 200
        };

        // 游戏状态
        const gameState = {
            player: {
                x: 50,
                y: 0,
                width: 40,
                height: 60,
                velocityX: 0,
                velocityY: 0,
                isJumping: false,
                direction: 'right',
                animationFrame: 0,
                animationCounter: 0
            },
            camera: {
                x: 0
            },
            platforms: [],
            coins: [],
            enemies: [],
            blocks: [],
            pipes: [],
            score: 0,
            coinsCollected: 0,
            lives: 3,
            gameOver: false,
            levelWidth: 5000,
            keys: {
                left: false,
                right: false,
                jump: false
            }
        };

        // 获取DOM元素
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('game-container');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreElement = document.getElementById('final-score');
        const restartButton = document.getElementById('restart-btn');
        const livesElement = document.getElementById('lives');
        const coinsElement = document.getElementById('coins');
        const scoreElement = document.getElementById('score');
        const leftButton = document.getElementById('left-btn');
        const rightButton = document.getElementById('right-btn');
        const jumpButton = document.getElementById('jump-btn');

        // 调整画布大小
        function resizeCanvas() {
            canvas.width = gameContainer.clientWidth;
            canvas.height = gameContainer.clientHeight;
        }

        // 初始化游戏
        function initGame() {
            resizeCanvas();
            
            // 重置游戏状态
            gameState.player.x = 50;
            gameState.player.y = 0;
            gameState.player.velocityX = 0;
            gameState.player.velocityY = 0;
            gameState.player.isJumping = false;
            gameState.camera.x = 0;
            gameState.score = 0;
            gameState.coinsCollected = 0;
            gameState.lives = 3;
            gameState.gameOver = false;
            
            // 更新UI
            updateUI();
            
            // 创建游戏世界
            createWorld();
            
            // 隐藏游戏结束界面
            gameOverScreen.style.display = 'none';
            
            // 开始游戏循环
            if (!gameLoop) {
                gameLoop = requestAnimationFrame(update);
            }
        }

        // 创建游戏世界
        function createWorld() {
            // 清空现有元素
            gameState.platforms = [];
            gameState.coins = [];
            gameState.enemies = [];
            gameState.blocks = [];
            gameState.pipes = [];
            
            // 创建地面
            for (let x = 0; x < gameState.levelWidth; x += 70) {
                gameState.platforms.push({
                    x: x,
                    y: canvas.height - config.groundHeight,
                    width: 70,
                    height: config.groundHeight
                });
            }
            
            // 创建平台
            const platformPositions = [
                {x: 300, y: canvas.height - 150, width: 200, height: 20},
                {x: 600, y: canvas.height - 200, width: 150, height: 20},
                {x: 900, y: canvas.height - 250, width: 200, height: 20},
                {x: 1200, y: canvas.height - 150, width: 200, height: 20},
                {x: 1500, y: canvas.height - 200, width: 150, height: 20},
                {x: 1800, y: canvas.height - 250, width: 200, height: 20},
                {x: 2100, y: canvas.height - 150, width: 200, height: 20},
                {x: 2400, y: canvas.height - 200, width: 150, height: 20},
                {x: 2700, y: canvas.height - 250, width: 200, height: 20},
                {x: 3000, y: canvas.height - 150, width: 200, height: 20},
                {x: 3300, y: canvas.height - 200, width: 150, height: 20},
                {x: 3600, y: canvas.height - 250, width: 200, height: 20},
                {x: 3900, y: canvas.height - 150, width: 200, height: 20},
                {x: 4200, y: canvas.height - 200, width: 150, height: 20},
                {x: 4500, y: canvas.height - 250, width: 200, height: 20}
            ];
            
            platformPositions.forEach(platform => {
                gameState.platforms.push(platform);
            });
            
            // 创建金币
            const coinPositions = [
                {x: 350, y: canvas.height - 200},
                {x: 400, y: canvas.height - 200},
                {x: 450, y: canvas.height - 200},
                {x: 650, y: canvas.height - 250},
                {x: 700, y: canvas.height - 250},
                {x: 750, y: canvas.height - 250},
                {x: 950, y: canvas.height - 300},
                {x: 1000, y: canvas.height - 300},
                {x: 1050, y: canvas.height - 300},
                {x: 1250, y: canvas.height - 200},
                {x: 1300, y: canvas.height - 200},
                {x: 1350, y: canvas.height - 200},
                {x: 1550, y: canvas.height - 250},
                {x: 1600, y: canvas.height - 250},
                {x: 1650, y: canvas.height - 250},
                {x: 1850, y: canvas.height - 300},
                {x: 1900, y: canvas.height - 300},
                {x: 1950, y: canvas.height - 300},
                {x: 2150, y: canvas.height - 200},
                {x: 2200, y: canvas.height - 200},
                {x: 2250, y: canvas.height - 200},
                {x: 2450, y: canvas.height - 250},
                {x: 2500, y: canvas.height - 250},
                {x: 2550, y: canvas.height - 250},
                {x: 2750, y: canvas.height - 300},
                {x: 2800, y: canvas.height - 300},
                {x: 2850, y: canvas.height - 300},
                {x: 3050, y: canvas.height - 200},
                {x: 3100, y: canvas.height - 200},
                {x: 3150, y: canvas.height - 200}
            ];
            
            coinPositions.forEach(position => {
                gameState.coins.push({
                    x: position.x,
                    y: position.y,
                    width: 20,
                    height: 20,
                    collected: false
                });
            });
            
            // 创建敌人
            const enemyPositions = [
                {x: 500, y: canvas.height - config.groundHeight - 40},
                {x: 800, y: canvas.height - config.groundHeight - 40},
                {x: 1100, y: canvas.height - config.groundHeight - 40},
                {x: 1400, y: canvas.height - config.groundHeight - 40},
                {x: 1700, y: canvas.height - config.groundHeight - 40},
                {x: 2000, y: canvas.height - config.groundHeight - 40},
                {x: 2300, y: canvas.height - config.groundHeight - 40},
                {x: 2600, y: canvas.height - config.groundHeight - 40},
                {x: 2900, y: canvas.height - config.groundHeight - 40},
                {x: 3200, y: canvas.height - config.groundHeight - 40},
                {x: 3500, y: canvas.height - config.groundHeight - 40},
                {x: 3800, y: canvas.height - config.groundHeight - 40},
                {x: 4100, y: canvas.height - config.groundHeight - 40},
                {x: 4400, y: canvas.height - config.groundHeight - 40}
            ];
            
            enemyPositions.forEach(position => {
                gameState.enemies.push({
                    x: position.x,
                    y: position.y,
                    width: 40,
                    height: 40,
                    velocityX: -config.enemySpeed,
                    direction: 'left',
                    startX: position.x - 100,
                    endX: position.x + 100
                });
            });
            
            // 创建管道
            const pipePositions = [
                {x: 700, y: canvas.height - config.groundHeight - 80},
                {x: 1400, y: canvas.height - config.groundHeight - 80},
                {x: 2100, y: canvas.height - config.groundHeight - 80},
                {x: 2800, y: canvas.height - config.groundHeight - 80},
                {x: 3500, y: canvas.height - config.groundHeight - 80},
                {x: 4200, y: canvas.height - config.groundHeight - 80}
            ];
            
            pipePositions.forEach(position => {
                gameState.pipes.push({
                    x: position.x,
                    y: position.y,
                    width: 60,
                    height: 80
                });
            });
            
            // 创建砖块
            const blockPositions = [
                {x: 400, y: canvas.height - 250},
                {x: 440, y: canvas.height - 250},
                {x: 480, y: canvas.height - 250},
                {x: 1000, y: canvas.height - 250},
                {x: 1040, y: canvas.height - 250},
                {x: 1080, y: canvas.height - 250},
                {x: 1600, y: canvas.height - 300},
                {x: 1640, y: canvas.height - 300},
                {x: 1680, y: canvas.height - 300},
                {x: 2200, y: canvas.height - 250},
                {x: 2240, y: canvas.height - 250},
                {x: 2280, y: canvas.height - 250},
                {x: 2800, y: canvas.height - 350},
                {x: 2840, y: canvas.height - 350},
                {x: 2880, y: canvas.height - 350},
                {x: 3400, y: canvas.height - 250},
                {x: 3440, y: canvas.height - 250},
                {x: 3480, y: canvas.height - 250},
                {x: 4000, y: canvas.height - 300},
                {x: 4040, y: canvas.height - 300},
                {x: 4080, y: canvas.height - 300}
            ];
            
            blockPositions.forEach(position => {
                gameState.blocks.push({
                    x: position.x,
                    y: position.y,
                    width: 40,
                    height: 40
                });
            });
        }

        // 更新UI
        function updateUI() {
            livesElement.textContent = gameState.lives;
            coinsElement.textContent = gameState.coinsCollected;
            scoreElement.textContent = gameState.score;
        }

        // 游戏更新函数
        function update() {
            if (gameState.gameOver) {
                return;
            }
            
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 更新玩家位置
            updatePlayer();
            
            // 更新敌人
            updateEnemies();
            
            // 检测碰撞
            checkCollisions();
            
            // 渲染游戏
            render();
            
            // 继续游戏循环
            gameLoop = requestAnimationFrame(update);
        }

        // 更新玩家
        function updatePlayer() {
            // 应用重力
            gameState.player.velocityY += config.gravity;
            
            // 根据按键更新速度
            if (gameState.keys.left) {
                gameState.player.velocityX = -config.playerSpeed;
                gameState.player.direction = 'left';
            } else if (gameState.keys.right) {
                gameState.player.velocityX = config.playerSpeed;
                gameState.player.direction = 'right';
            } else {
                gameState.player.velocityX = 0;
            }
            
            // 跳跃
            if (gameState.keys.jump && !gameState.player.isJumping) {
                gameState.player.velocityY = -config.jumpForce;
                gameState.player.isJumping = true;
            }
            
            // 更新位置
            gameState.player.x += gameState.player.velocityX;
            gameState.player.y += gameState.player.velocityY;
            
            // 边界检查
            if (gameState.player.x < 0) {
                gameState.player.x = 0;
            }
            
            if (gameState.player.x > gameState.levelWidth - gameState.player.width) {
                gameState.player.x = gameState.levelWidth - gameState.player.width;
            }
            
            // 如果玩家掉出屏幕底部
            if (gameState.player.y > canvas.height) {
                playerDie();
            }
            
            // 更新相机位置
            updateCamera();
            
            // 更新动画帧
            gameState.player.animationCounter++;
            if (gameState.player.animationCounter >= 10) {
                gameState.player.animationFrame = (gameState.player.animationFrame + 1) % 3;
                gameState.player.animationCounter = 0;
            }
        }

        // 更新相机位置
        function updateCamera() {
            // 相机跟随玩家，保持玩家在屏幕中间
            const targetX = gameState.player.x - canvas.width / 2 + gameState.player.width / 2;
            
            // 限制相机不超出关卡边界
            if (targetX < 0) {
                gameState.camera.x = 0;
            } else if (targetX > gameState.levelWidth - canvas.width) {
                gameState.camera.x = gameState.levelWidth - canvas.width;
            } else {
                gameState.camera.x = targetX;
            }
        }

        // 更新敌人
        function updateEnemies() {
            gameState.enemies.forEach(enemy => {
                // 移动敌人
                enemy.x += enemy.velocityX;
                
                // 敌人巡逻范围
                if (enemy.x <= enemy.startX) {
                    enemy.velocityX = config.enemySpeed;
                    enemy.direction = 'right';
                } else if (enemy.x >= enemy.endX) {
                    enemy.velocityX = -config.enemySpeed;
                    enemy.direction = 'left';
                }
            });
        }

        // 检测碰撞
        function checkCollisions() {
            // 检测与平台的碰撞
            let onGround = false;
            
            gameState.platforms.forEach(platform => {
                // 检查玩家是否站在平台上
                if (gameState.player.x + gameState.player.width > platform.x &&
                    gameState.player.x < platform.x + platform.width &&
                    gameState.player.y + gameState.player.height <= platform.y &&
                    gameState.player.y + gameState.player.height + gameState.player.velocityY >= platform.y) {
                    
                    gameState.player.y = platform.y - gameState.player.height;
                    gameState.player.velocityY = 0;
                    gameState.player.isJumping = false;
                    onGround = true;
                }
                
                // 检查玩家是否撞到平台侧面
                if (gameState.player.x + gameState.player.width > platform.x &&
                    gameState.player.x < platform.x + platform.width &&
                    gameState.player.y + gameState.player.height > platform.y &&
                    gameState.player.y < platform.y + platform.height) {
                    
                    // 从左侧碰撞
                    if (gameState.player.x + gameState.player.width - platform.x < 10 && gameState.player.velocityX > 0) {
                        gameState.player.x = platform.x - gameState.player.width;
                    }
                    // 从右侧碰撞
                    else if (platform.x + platform.width - gameState.player.x < 10 && gameState.player.velocityX < 0) {
                        gameState.player.x = platform.x + platform.width;
                    }
                }
            });
            
            // 检测与砖块的碰撞
            gameState.blocks.forEach(block => {
                // 检查玩家是否站在砖块上
                if (gameState.player.x + gameState.player.width > block.x &&
                    gameState.player.x < block.x + block.width &&
                    gameState.player.y + gameState.player.height <= block.y &&
                    gameState.player.y + gameState.player.height + gameState.player.velocityY >= block.y) {
                    
                    gameState.player.y = block.y - gameState.player.height;
                    gameState.player.velocityY = 0;
                    gameState.player.isJumping = false;
                    onGround = true;
                }
                
                // 检查玩家是否撞到砖块底部
                if (gameState.player.x + gameState.player.width > block.x &&
                    gameState.player.x < block.x + block.width &&
                    gameState.player.y <= block.y + block.height &&
                    gameState.player.y + gameState.player.velocityY >= block.y + block.height) {
                    
                    gameState.player.y = block.y + block.height;
                    gameState.player.velocityY = 0;
                }
                
                // 检查玩家是否撞到砖块侧面
                if (gameState.player.x + gameState.player.width > block.x &&
                    gameState.player.x < block.x + block.width &&
                    gameState.player.y + gameState.player.height > block.y &&
                    gameState.player.y < block.y + block.height) {
                    
                    // 从左侧碰撞
                    if (gameState.player.x + gameState.player.width - block.x < 10 && gameState.player.velocityX > 0) {
                        gameState.player.x = block.x - gameState.player.width;
                    }
                    // 从右侧碰撞
                    else if (block.x + block.width - gameState.player.x < 10 && gameState.player.velocityX < 0) {
                        gameState.player.x = block.x + block.width;
                    }
                }
            });
            
            // 检测与管道的碰撞
            gameState.pipes.forEach(pipe => {
                // 检查玩家是否站在管道上
                if (gameState.player.x + gameState.player.width > pipe.x &&
                    gameState.player.x < pipe.x + pipe.width &&
                    gameState.player.y + gameState.player.height <= pipe.y &&
                    gameState.player.y + gameState.player.height + gameState.player.velocityY >= pipe.y) {
                    
                    gameState.player.y = pipe.y - gameState.player.height;
                    gameState.player.velocityY = 0;
                    gameState.player.isJumping = false;
                    onGround = true;
                }
                
                // 检查玩家是否撞到管道侧面
                if (gameState.player.x + gameState.player.width > pipe.x &&
                    gameState.player.x < pipe.x + pipe.width &&
                    gameState.player.y + gameState.player.height > pipe.y &&
                    gameState.player.y < pipe.y + pipe.height) {
                    
                    // 从左侧碰撞
                    if (gameState.player.x + gameState.player.width - pipe.x < 10 && gameState.player.velocityX > 0) {
                        gameState.player.x = pipe.x - gameState.player.width;
                    }
                    // 从右侧碰撞
                    else if (pipe.x + pipe.width - gameState.player.x < 10 && gameState.player.velocityX < 0) {
                        gameState.player.x = pipe.x + pipe.width;
                    }
                }
            });
            
            // 检测与金币的碰撞
            gameState.coins.forEach(coin => {
                if (!coin.collected &&
                    gameState.player.x + gameState.player.width > coin.x &&
                    gameState.player.x < coin.x + coin.width &&
                    gameState.player.y + gameState.player.height > coin.y &&
                    gameState.player.y < coin.y + coin.height) {
                    
                    coin.collected = true;
                    gameState.coinsCollected++;
                    gameState.score += config.coinValue;
                    updateUI();
                }
            });
            
            // 检测与敌人的碰撞
            gameState.enemies.forEach(enemy => {
                if (gameState.player.x + gameState.player.width > enemy.x &&
                    gameState.player.x < enemy.x + enemy.width &&
                    gameState.player.y + gameState.player.height > enemy.y &&
                    gameState.player.y < enemy.y + enemy.height) {
                    
                    // 如果玩家从上方跳到敌人头上
                    if (gameState.player.velocityY > 0 && 
                        gameState.player.y + gameState.player.height < enemy.y + enemy.height / 2) {
                        
                        // 消灭敌人
                        enemy.y = canvas.height * 2; // 移出屏幕
                        gameState.score += config.enemyValue;
                        updateUI();
                        
                        // 反弹
                        gameState.player.velocityY = -config.jumpForce / 1.5;
                    } else {
                        // 玩家受伤
                        playerDie();
                    }
                }
            });
            
            // 如果玩家到达关卡末尾
            if (gameState.player.x > gameState.levelWidth - gameState.player.width - 50) {
                gameWin();
            }
        }

        // 玩家死亡
        function playerDie() {
            gameState.lives--;
            updateUI();
            
            if (gameState.lives <= 0) {
                gameOver();
            } else {
                // 重置玩家位置
                gameState.player.x = 50;
                gameState.player.y = 0;
                gameState.player.velocityX = 0;
                gameState.player.velocityY = 0;
                gameState.camera.x = 0;
            }
        }

                    // 游戏胜利
                    function gameWin() {
                gameState.score += gameState.lives * 1000; // 每条命额外奖励1000分
                updateUI();
                
                // 显示游戏结束界面
                finalScoreElement.textContent = gameState.score;
                gameOverScreen.style.display = 'flex';
                gameOverScreen.querySelector('h2').textContent = '恭喜通关!';
                
                gameState.gameOver = true;
                cancelAnimationFrame(gameLoop);
            }

            // 游戏结束
            function gameOver() {
                // 显示游戏结束界面
                finalScoreElement.textContent = gameState.score;
                gameOverScreen.style.display = 'flex';
                gameOverScreen.querySelector('h2').textContent = '游戏结束!';
                
                gameState.gameOver = true;
                cancelAnimationFrame(gameLoop);
            }

            // 渲染游戏
            function render() {
                // 绘制背景
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 绘制云朵
                ctx.fillStyle = '#FFFFFF';
                for (let i = 0; i < 10; i++) {
                    const cloudX = (i * 300 - gameState.camera.x * 0.5) % (gameState.levelWidth * 1.5) - 100;
                    if (cloudX > -100 && cloudX < canvas.width + 100) {
                        drawCloud(cloudX, 50 + (i % 3) * 30);
                    }
                }
                
                // 绘制远景山脉
                ctx.fillStyle = '#5D94FB';
                for (let i = 0; i < 20; i++) {
                    const mountainX = (i * 200 - gameState.camera.x * 0.3) % (gameState.levelWidth * 1.5) - 100;
                    if (mountainX > -100 && mountainX < canvas.width + 100) {
                        drawMountain(mountainX, canvas.height - 150, 100, 150);
                    }
                }
                
                // 绘制平台
                ctx.fillStyle = '#8B4513';
                gameState.platforms.forEach(platform => {
                    if (isVisible(platform)) {
                        ctx.fillRect(
                            platform.x - gameState.camera.x,
                            platform.y,
                            platform.width,
                            platform.height
                        );
                        
                        // 绘制草地
                        if (platform.y === canvas.height - config.groundHeight) {
                            ctx.fillStyle = '#228B22';
                            ctx.fillRect(
                                platform.x - gameState.camera.x,
                                platform.y,
                                platform.width,
                                10
                            );
                            ctx.fillStyle = '#8B4513';
                        }
                    }
                });
                
                // 绘制砖块
                ctx.fillStyle = '#B87333';
                gameState.blocks.forEach(block => {
                    if (isVisible(block)) {
                        ctx.fillRect(
                            block.x - gameState.camera.x,
                            block.y,
                            block.width,
                            block.height
                        );
                        
                        // 绘制砖块纹理
                        ctx.strokeStyle = '#8B4513';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(
                            block.x - gameState.camera.x + 2,
                            block.y + 2,
                            block.width - 4,
                            block.height - 4
                        );
                    }
                });
                
                // 绘制管道
                ctx.fillStyle = '#00AA00';
                gameState.pipes.forEach(pipe => {
                    if (isVisible(pipe)) {
                        ctx.fillRect(
                            pipe.x - gameState.camera.x,
                            pipe.y,
                            pipe.width,
                            pipe.height
                        );
                        
                        // 绘制管道顶部
                        ctx.fillRect(
                            pipe.x - gameState.camera.x - 5,
                            pipe.y,
                            pipe.width + 10,
                            10
                        );
                    }
                });
                
                // 绘制金币
                ctx.fillStyle = '#FFD700';
                gameState.coins.forEach(coin => {
                    if (!coin.collected && isVisible(coin)) {
                        ctx.beginPath();
                        ctx.arc(
                            coin.x - gameState.camera.x + coin.width / 2,
                            coin.y + coin.height / 2,
                            coin.width / 2,
                            0,
                            Math.PI * 2
                        );
                        ctx.fill();
                        
                        // 绘制金币闪光效果
                        ctx.fillStyle = '#FFFFFF';
                        ctx.beginPath();
                        ctx.arc(
                            coin.x - gameState.camera.x + coin.width / 2 - 3,
                            coin.y + coin.height / 2 - 3,
                            coin.width / 6,
                            0,
                            Math.PI * 2
                        );
                        ctx.fill();
                        ctx.fillStyle = '#FFD700';
                    }
                });
                
                // 绘制敌人
                ctx.fillStyle = '#8B0000';
                gameState.enemies.forEach(enemy => {
                    if (isVisible(enemy)) {
                        // 绘制敌人身体
                        ctx.fillRect(
                            enemy.x - gameState.camera.x,
                            enemy.y,
                            enemy.width,
                            enemy.height
                        );
                        
                        // 绘制敌人眼睛
                        ctx.fillStyle = '#FFFFFF';
                        const eyeX = enemy.direction === 'left' ? 
                            enemy.x - gameState.camera.x + 5 : 
                            enemy.x - gameState.camera.x + enemy.width - 15;
                        
                        ctx.fillRect(eyeX, enemy.y + 10, 10, 10);
                        
                        // 绘制敌人瞳孔
                        ctx.fillStyle = '#000000';
                        const pupilX = enemy.direction === 'left' ? 
                            enemy.x - gameState.camera.x + 8 : 
                            enemy.x - gameState.camera.x + enemy.width - 12;
                        
                        ctx.fillRect(pupilX, enemy.y + 12, 4, 6);
                        
                        ctx.fillStyle = '#8B0000';
                    }
                });
                
                // 绘制玩家
                ctx.fillStyle = '#E52521'; // 红色
                
                // 绘制玩家身体
                ctx.fillRect(
                    gameState.player.x - gameState.camera.x,
                    gameState.player.y,
                    gameState.player.width,
                    gameState.player.height
                );
                
                // 绘制玩家帽子
                ctx.fillRect(
                    gameState.player.x - gameState.camera.x - 5,
                    gameState.player.y,
                    gameState.player.width + 10,
                    15
                );
                
                // 绘制玩家眼睛
                ctx.fillStyle = '#FFFFFF';
                const eyeX = gameState.player.direction === 'left' ? 
                    gameState.player.x - gameState.camera.x + 5 : 
                    gameState.player.x - gameState.camera.x + gameState.player.width - 15;
                
                ctx.fillRect(eyeX, gameState.player.y + 20, 10, 10);
                
                // 绘制玩家瞳孔
                ctx.fillStyle = '#000000';
                const pupilX = gameState.player.direction === 'left' ? 
                    gameState.player.x - gameState.camera.x + 8 : 
                    gameState.player.x - gameState.camera.x + gameState.player.width - 12;
                
                ctx.fillRect(pupilX, gameState.player.y + 22, 4, 6);
                
                // 绘制玩家胡子
                ctx.fillRect(
                    gameState.player.x - gameState.camera.x + 10,
                    gameState.player.y + 40,
                    gameState.player.width - 20,
                    3
                );
                
                // 绘制玩家鼻子
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(
                    gameState.player.x - gameState.camera.x + 15,
                    gameState.player.y + 30,
                    10,
                    10
                );
                
                // 绘制玩家手臂
                ctx.fillStyle = '#E52521';
                if (gameState.player.velocityX !== 0) {
                    // 移动时摆动手臂
                    const armOffset = Math.sin(gameState.player.animationFrame * Math.PI / 1.5) * 5;
                    
                    ctx.fillRect(
                        gameState.player.x - gameState.camera.x - 5,
                        gameState.player.y + 25 + armOffset,
                        10,
                        20
                    );
                    
                    ctx.fillRect(
                        gameState.player.x - gameState.camera.x + gameState.player.width - 5,
                        gameState.player.y + 25 - armOffset,
                        10,
                        20
                    );
                } else {
                    // 静止时手臂垂直
                    ctx.fillRect(
                        gameState.player.x - gameState.camera.x - 5,
                        gameState.player.y + 25,
                        10,
                        20
                    );
                    
                    ctx.fillRect(
                        gameState.player.x - gameState.camera.x + gameState.player.width - 5,
                        gameState.player.y + 25,
                        10,
                        20
                    );
                }
                
                // 绘制玩家腿部
                if (gameState.player.velocityX !== 0) {
                    // 移动时摆动腿部
                    const legOffset = Math.sin(gameState.player.animationFrame * Math.PI / 1.5) * 5;
                    
                    ctx.fillRect(
                        gameState.player.x - gameState.camera.x + 5,
                        gameState.player.y + gameState.player.height - 20 + legOffset,
                        10,
                        20
                    );
                    
                    ctx.fillRect(
                        gameState.player.x - gameState.camera.x + gameState.player.width - 15,
                        gameState.player.y + gameState.player.height - 20 - legOffset,
                        10,
                        20
                    );
                } else {
                    // 静止时腿部并拢
                    ctx.fillRect(
                        gameState.player.x - gameState.camera.x + 5,
                        gameState.player.y + gameState.player.height - 20,
                        10,
                        20
                    );
                    
                    ctx.fillRect(
                        gameState.player.x - gameState.camera.x + gameState.player.width - 15,
                        gameState.player.y + gameState.player.height - 20,
                        10,
                        20
                    );
                }
            }

            // 绘制云朵
            function drawCloud(x, y) {
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, Math.PI * 2);
                ctx.arc(x + 15, y - 10, 15, 0, Math.PI * 2);
                ctx.arc(x + 30, y, 20, 0, Math.PI * 2);
                ctx.arc(x + 15, y + 10, 15, 0, Math.PI * 2);
                ctx.fill();
            }

            // 绘制山脉
            function drawMountain(x, y, width, height) {
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + width / 2, y - height);
                ctx.lineTo(x + width, y);
                ctx.closePath();
                ctx.fill();
            }

            // 检查元素是否在视野内
            function isVisible(element) {
                return element.x + element.width > gameState.camera.x && 
                       element.x < gameState.camera.x + canvas.width;
            }

            // 键盘控制
            document.addEventListener('keydown', (e) => {
                switch (e.key) {
                    case 'ArrowLeft':
                        gameState.keys.left = true;
                        break;
                    case 'ArrowRight':
                        gameState.keys.right = true;
                        break;
                    case 'ArrowUp':
                    case ' ':
                        gameState.keys.jump = true;
                        break;
                }
            });

            document.addEventListener('keyup', (e) => {
                switch (e.key) {
                    case 'ArrowLeft':
                        gameState.keys.left = false;
                        break;
                    case 'ArrowRight':
                        gameState.keys.right = false;
                        break;
                    case 'ArrowUp':
                    case ' ':
                        gameState.keys.jump = false;
                        break;
                }
            });

            // 触摸控制
            leftButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.keys.left = true;
            });

            leftButton.addEventListener('touchend', () => {
                gameState.keys.left = false;
            });

            rightButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.keys.right = true;
            });

            rightButton.addEventListener('touchend', () => {
                gameState.keys.right = false;
            });

            jumpButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.keys.jump = true;
            });

            jumpButton.addEventListener('touchend', () => {
                gameState.keys.jump = false;
            });

            // 鼠标控制
            leftButton.addEventListener('mousedown', () => {
                gameState.keys.left = true;
            });

            leftButton.addEventListener('mouseup', () => {
                gameState.keys.left = false;
            });

            leftButton.addEventListener('mouseleave', () => {
                gameState.keys.left = false;
            });

            rightButton.addEventListener('mousedown', () => {
                gameState.keys.right = true;
            });

            rightButton.addEventListener('mouseup', () => {
                gameState.keys.right = false;
            });

            rightButton.addEventListener('mouseleave', () => {
                gameState.keys.right = false;
            });

            jumpButton.addEventListener('mousedown', () => {
                gameState.keys.jump = true;
            });

            jumpButton.addEventListener('mouseup', () => {
                gameState.keys.jump = false;
            });

            jumpButton.addEventListener('mouseleave', () => {
                gameState.keys.jump = false;
            });

            // 重新开始按钮
            restartButton.addEventListener('click', initGame);

            // 窗口大小改变时重新调整画布大小
            window.addEventListener('resize', resizeCanvas);

            // 游戏循环
            let gameLoop = null;

            // 初始化游戏
            initGame();
        </script>
    </body>
</html>
